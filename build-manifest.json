{
  "last_updated_by": "BE-4",
  "last_updated_at": "2026-02-10T20:18:39Z",
  "nodes": {
    "BE-0": {
      "title": "Async FastAPI backend scaffold with DB healthcheck and Alembic wiring",
      "completed_at": "2026-02-10T13:37:53Z",
      "contracts": {
        "ApiError": {
          "type": "object",
          "fields": {
            "code": {
              "type": "string",
              "nullable": false
            },
            "message": {
              "type": "string",
              "nullable": false
            },
            "details": {
              "type": "dict | list | string | null",
              "nullable": true,
              "optional": true,
              "default": null
            }
          }
        },
        "ApiErrorResponse": {
          "type": "object",
          "fields": {
            "error": {
              "type": "ApiError",
              "nullable": false
            }
          }
        },
        "HealthResponse": {
          "type": "object",
          "fields": {
            "status": {
              "type": "string",
              "nullable": false
            },
            "service": {
              "type": "string",
              "nullable": false
            },
            "db": {
              "type": "object",
              "nullable": false,
              "fields": {
                "status": {
                  "type": "string",
                  "nullable": false
                }
              }
            }
          }
        }
      },
      "schemas": {
        "sqlalchemy_models": {
          "Base": "class Base(DeclarativeBase): pass"
        },
        "database_tables": []
      },
      "files_created": [
        "app/__init__.py",
        "app/main.py",
        "app/api/__init__.py",
        "app/api/health.py",
        "app/core/__init__.py",
        "app/core/config.py",
        "app/core/constants.py",
        "app/core/errors.py",
        "app/db/__init__.py",
        "app/db/base.py",
        "app/db/session.py",
        "app/middleware/__init__.py",
        "app/middleware/rate_limit.py",
        "alembic.ini",
        "alembic/env.py",
        "alembic/README",
        "alembic/script.py.mako",
        "alembic/versions/.gitkeep",
        "pyproject.toml",
        ".env.example",
        "README.md",
        "build-manifest.json"
      ],
      "decisions": [
        "DATABASE_URL normalization is centralized in app.db.session.normalize_database_url and converts postgres:// and postgresql:// to postgresql+asyncpg:// for runtime and Alembic use.",
        "Application startup is tolerant of missing DATABASE_URL and OPENAI_API_KEY; database reachability is enforced at request time in GET /health.",
        "Error envelope standardization is applied globally via exception handlers, including Starlette HTTP exceptions (e.g. 404), to always return ApiErrorResponse on non-2xx outcomes.",
        "Canonical topics are defined as backend constants in app/core/constants.py for reuse in later phases without DB storage in Phase 0.",
        "Health DB checks use a short-lived async engine per request to keep startup lightweight and satisfy explicit DB ping contract behavior."
      ],
      "environment_variables": [
        {
          "key": "DATABASE_URL",
          "required": true,
          "description": "PostgreSQL connection URL used by /health DB ping and Alembic migrations; normalized to postgresql+asyncpg://."
        },
        {
          "key": "OPENAI_API_KEY",
          "required": false,
          "description": "Placeholder for future OpenAI integration; intentionally non-blocking during startup in Phase 0."
        },
        {
          "key": "CORS_ALLOWED_ORIGINS",
          "required": false,
          "description": "Comma-separated CORS allowlist. Defaults to http://localhost:5173,http://localhost:3000 when unset or empty."
        }
      ],
      "enums": [
        {
          "name": "CANONICAL_TOPICS",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "python_api"
          ]
        }
      ],
      "response_schemas": {
        "GET /health": {
          "200": {
            "type": "object",
            "fields": {
              "status": {
                "type": "string",
                "nullable": false,
                "literal": "ok"
              },
              "service": {
                "type": "string",
                "nullable": false,
                "literal": "five-by-backend"
              },
              "db": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "status": {
                    "type": "string",
                    "nullable": false,
                    "literal": "ok"
                  }
                }
              }
            }
          },
          "503": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "db_unavailable"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Database is not reachable"
                  }
                }
              }
            }
          },
          "500": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "internal_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Unexpected server error"
                  }
                }
              }
            }
          }
        }
      }
    },
    "BE-1": {
      "title": "Core Data Model + Migrations + Grid Loader",
      "completed_at": "2026-02-10T15:19:57Z",
      "contracts": {
        "load_session_snapshot": {
          "type": "async_function",
          "signature": "load_session_snapshot(session_id: uuid.UUID, db: AsyncSession) -> SessionSnapshot",
          "raises": [
            "SessionSnapshotNotFoundError"
          ]
        },
        "CellSnapshot": {
          "type": "object",
          "fields": {
            "index": {
              "type": "int",
              "nullable": false,
              "constraints": "0 <= index <= 24"
            },
            "row": {
              "type": "int",
              "nullable": false,
              "constraints": "0 <= row <= 4"
            },
            "col": {
              "type": "int",
              "nullable": false,
              "constraints": "0 <= col <= 4"
            },
            "revealed": {
              "type": "bool",
              "nullable": false
            },
            "locked": {
              "type": "bool",
              "nullable": false
            },
            "letter": {
              "type": "string",
              "nullable": true,
              "constraints": "^[A-Z]$ when present"
            },
            "revealed_by": {
              "type": "RevealedBy",
              "nullable": true
            },
            "topics": {
              "type": "Topic[]",
              "nullable": false,
              "constraints": "must exactly equal CANONICAL_TOPICS order"
            }
          }
        },
        "PlayerSnapshot": {
          "type": "object",
          "fields": {
            "player_number": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "name": {
              "type": "string",
              "nullable": true
            },
            "score": {
              "type": "int",
              "nullable": false
            },
            "grid_id": {
              "type": "int",
              "nullable": false
            },
            "completed": {
              "type": "bool",
              "nullable": false
            },
            "cells": {
              "type": "CellSnapshot[]",
              "nullable": false
            }
          }
        },
        "LastEvent": {
          "type": "object",
          "fields": {
            "type": {
              "type": "EventType",
              "nullable": false
            },
            "event_data": {
              "type": "object",
              "nullable": false
            },
            "created_at": {
              "type": "datetime",
              "nullable": false
            }
          }
        },
        "SessionSnapshot": {
          "type": "object",
          "fields": {
            "session_id": {
              "type": "uuid",
              "nullable": false
            },
            "status": {
              "type": "SessionStatus",
              "nullable": false
            },
            "current_turn": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "players": {
              "type": "PlayerSnapshot[2]",
              "nullable": false
            },
            "last_event": {
              "type": "LastEvent",
              "nullable": true
            },
            "created_at": {
              "type": "datetime",
              "nullable": false
            },
            "updated_at": {
              "type": "datetime",
              "nullable": false
            }
          }
        }
      },
      "schemas": {
        "postgres_enums": {
          "topic": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "session_status": [
            "in_progress",
            "complete"
          ],
          "revealed_by": [
            "question",
            "guess",
            "auto"
          ],
          "event_type": [
            "question_asked",
            "question_answered",
            "letter_guessed",
            "word_guessed"
          ]
        },
        "tables": {
          "grids": {
            "columns": {
              "id": "BIGSERIAL PRIMARY KEY",
              "cells": "CHAR(25) NOT NULL",
              "words_across": "TEXT[] NOT NULL",
              "words_down": "TEXT[] NOT NULL",
              "created_at": "TIMESTAMPTZ NOT NULL DEFAULT now()"
            },
            "constraints": [
              "UNIQUE (cells)",
              "CHECK (char_length(cells)=25)",
              "CHECK (array_length(words_across,1)=5)",
              "CHECK (array_length(words_down,1)=5)"
            ],
            "indexes": []
          },
          "sessions": {
            "columns": {
              "id": "UUID PRIMARY KEY DEFAULT gen_random_uuid()",
              "status": "session_status NOT NULL DEFAULT 'in_progress'",
              "current_turn": "SMALLINT NOT NULL DEFAULT 1",
              "player_1_grid_id": "BIGINT NOT NULL REFERENCES grids(id)",
              "player_2_grid_id": "BIGINT NOT NULL REFERENCES grids(id)",
              "player_1_name": "VARCHAR(30) NULL",
              "player_2_name": "VARCHAR(30) NULL",
              "player_1_score": "INT NOT NULL DEFAULT 100",
              "player_2_score": "INT NOT NULL DEFAULT 100",
              "created_at": "TIMESTAMPTZ NOT NULL DEFAULT now()",
              "updated_at": "TIMESTAMPTZ NOT NULL DEFAULT now()"
            },
            "constraints": [
              "CHECK (current_turn IN (1,2))"
            ],
            "indexes": [
              "sessions_status_created_at_idx (status, created_at)"
            ]
          },
          "cell_states": {
            "columns": {
              "session_id": "UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE",
              "player_number": "SMALLINT NOT NULL",
              "cell_index": "SMALLINT NOT NULL",
              "revealed": "BOOLEAN NOT NULL DEFAULT false",
              "locked": "BOOLEAN NOT NULL DEFAULT false",
              "letter": "CHAR(1) NULL",
              "revealed_by": "revealed_by NULL",
              "topics_used": "topic[] NOT NULL DEFAULT ARRAY[]::topic[]",
              "created_at": "TIMESTAMPTZ NOT NULL DEFAULT now()",
              "updated_at": "TIMESTAMPTZ NOT NULL DEFAULT now()"
            },
            "constraints": [
              "PRIMARY KEY (session_id, player_number, cell_index)",
              "CHECK (player_number IN (1,2))",
              "CHECK (cell_index BETWEEN 0 AND 24)",
              "CHECK (letter ~ '^[A-Z]$')",
              "CHECK (revealed OR (letter IS NULL AND revealed_by IS NULL))"
            ],
            "indexes": [
              "cell_states_session_player_idx (session_id, player_number)",
              "cell_states_session_player_locked_idx (session_id, player_number, locked)"
            ]
          },
          "cell_locks": {
            "columns": {
              "id": "BIGSERIAL PRIMARY KEY",
              "session_id": "UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE",
              "player_number": "SMALLINT NOT NULL",
              "cell_index": "SMALLINT NOT NULL",
              "created_at": "TIMESTAMPTZ NOT NULL DEFAULT now()",
              "cleared_at": "TIMESTAMPTZ NULL"
            },
            "constraints": [
              "CHECK (player_number IN (1,2))",
              "CHECK (cell_index BETWEEN 0 AND 24)"
            ],
            "indexes": [
              "cell_locks_session_player_created_idx (session_id, player_number, created_at, id)",
              "cell_locks_session_player_uncleared_idx (session_id, player_number) WHERE cleared_at IS NULL",
              "cell_locks_session_player_cell_uncleared_idx (session_id, player_number, cell_index) WHERE cleared_at IS NULL"
            ]
          },
          "event_logs": {
            "columns": {
              "id": "BIGSERIAL PRIMARY KEY",
              "session_id": "UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE",
              "player_number": "SMALLINT NOT NULL",
              "type": "event_type NOT NULL",
              "event_data": "JSONB NOT NULL DEFAULT '{}'::jsonb",
              "created_at": "TIMESTAMPTZ NOT NULL DEFAULT now()"
            },
            "constraints": [
              "CHECK (player_number IN (1,2))"
            ],
            "indexes": [
              "event_logs_session_created_idx (session_id, created_at DESC, id DESC)",
              "event_logs_session_player_created_idx (session_id, player_number, created_at DESC, id DESC)"
            ]
          }
        }
      },
      "files_created": [
        "app/db/enums.py",
        "app/db/models/__init__.py",
        "app/db/models/grid.py",
        "app/db/models/session.py",
        "app/db/models/cell_state.py",
        "app/db/models/cell_lock.py",
        "app/db/models/event_log.py",
        "app/schemas/__init__.py",
        "app/schemas/enums.py",
        "app/schemas/session_snapshot.py",
        "app/services/__init__.py",
        "app/services/session_snapshot.py",
        "app/api/sessions.py",
        "scripts/seed_grids.py",
        "alembic/versions/20260210_150500_phase1_core_tables_and_enums.py",
        "alembic/env.py",
        "app/main.py",
        "app/core/constants.py",
        "build-manifest.json"
      ],
      "decisions": [
        "Session snapshot service returns exactly two players (1 and 2) and tolerates non-0/non-25 cell_state row counts by returning cells=[] with warning logs for frontend stability.",
        "Phase 1 serializer returns canonical topic order from CANONICAL_TOPICS for every cell as a stable contract surface before gameplay topic mutation logic is introduced.",
        "Missing sessions are converted to HTTP 404 with detail {code: session_not_found, message: Session not found} and then wrapped by global error handlers.",
        "Grid import supports .json (array) and .jsonl; invalid rows fail fast with row/line error context, and inserts are idempotent via ON CONFLICT (cells) DO NOTHING.",
        "Alembic migration leaves pgcrypto extension installed on downgrade while dropping Phase 1 tables and enums in reverse dependency order."
      ],
      "environment_variables": [],
      "enums": [
        {
          "name": "topic",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "session_status",
          "values": [
            "in_progress",
            "complete"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "revealed_by",
          "values": [
            "question",
            "guess",
            "auto"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "event_type",
          "values": [
            "question_asked",
            "question_answered",
            "letter_guessed",
            "word_guessed"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "CANONICAL_TOPICS",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "python_api"
          ]
        }
      ],
      "response_schemas": {
        "GET /sessions/{session_id}": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "players": {
                "type": "array",
                "nullable": false,
                "length": 2,
                "items": {
                  "type": "object",
                  "fields": {
                    "player_number": {
                      "type": "int",
                      "nullable": false,
                      "enum": [
                        1,
                        2
                      ]
                    },
                    "name": {
                      "type": "string",
                      "nullable": true
                    },
                    "score": {
                      "type": "int",
                      "nullable": false
                    },
                    "grid_id": {
                      "type": "int",
                      "nullable": false
                    },
                    "completed": {
                      "type": "bool",
                      "nullable": false
                    },
                    "cells": {
                      "type": "array",
                      "nullable": false,
                      "items": {
                        "type": "object",
                        "fields": {
                          "index": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..24"
                          },
                          "row": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "col": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "revealed": {
                            "type": "bool",
                            "nullable": false
                          },
                          "locked": {
                            "type": "bool",
                            "nullable": false
                          },
                          "letter": {
                            "type": "string",
                            "nullable": true,
                            "constraints": "^[A-Z]$"
                          },
                          "revealed_by": {
                            "type": "string",
                            "nullable": true,
                            "enum": [
                              "question",
                              "guess",
                              "auto"
                            ]
                          },
                          "topics": {
                            "type": "string[]",
                            "nullable": false,
                            "exact_order": [
                              "Politics",
                              "Science",
                              "History",
                              "Art",
                              "Current Affairs"
                            ]
                          }
                        }
                      }
                    }
                  }
                }
              },
              "last_event": {
                "type": "object",
                "nullable": true,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "question_asked",
                      "question_answered",
                      "letter_guessed",
                      "word_guessed"
                    ]
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "session_not_found"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Session not found"
                  }
                }
              }
            }
          },
          "422": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false
              }
            }
          },
          "500": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "internal_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Unexpected server error"
                  }
                }
              }
            }
          }
        }
      }
    },
    "BE-2": {
      "title": "Session lifecycle create endpoint and SessionSnapshot v1 contract alignment",
      "completed_at": "2026-02-10T17:14:22Z",
      "contracts": {
        "CreateSessionRequest": {
          "type": "object",
          "extra": "forbid",
          "fields": {
            "player_1_name": {
              "type": "string | null",
              "nullable": true,
              "required": false,
              "constraints": "trim whitespace; if provided length must be 1..30 after trim"
            },
            "player_2_name": {
              "type": "string | null",
              "nullable": true,
              "required": false,
              "constraints": "trim whitespace; if provided length must be 1..30 after trim"
            }
          }
        },
        "CellSnapshot": {
          "type": "object",
          "fields": {
            "index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "row": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "col": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "revealed": {
              "type": "bool",
              "nullable": false
            },
            "locked": {
              "type": "bool",
              "nullable": false
            },
            "letter": {
              "type": "string",
              "nullable": true,
              "constraints": "null when revealed=false; required and /^[A-Z]$/ when revealed=true"
            },
            "revealed_by": {
              "type": "RevealedBy | null",
              "nullable": true,
              "constraints": "must be null when revealed=false"
            },
            "topics_used": {
              "type": "Topic[]",
              "nullable": false,
              "constraints": "0 <= length <= 5"
            }
          }
        },
        "SessionSnapshot": {
          "type": "object",
          "fields": {
            "session_id": {
              "type": "uuid",
              "nullable": false
            },
            "status": {
              "type": "SessionStatus",
              "nullable": false
            },
            "current_turn": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "topics": {
              "type": "Topic[]",
              "nullable": false,
              "constraints": "must exactly equal canonical list in canonical order"
            },
            "players": {
              "type": "PlayerSnapshot[2]",
              "nullable": false
            },
            "last_event": {
              "type": "LastEvent | null",
              "nullable": true
            },
            "created_at": {
              "type": "datetime",
              "nullable": false
            },
            "updated_at": {
              "type": "datetime",
              "nullable": false
            }
          }
        },
        "create_session": {
          "type": "async_function",
          "signature": "create_session(*, db: AsyncSession, player_1_name: str | None, player_2_name: str | None) -> uuid.UUID",
          "raises": [
            "GridsUnavailableError"
          ],
          "behavior": "single transaction; picks two random distinct grids, inserts sessions row, eagerly inserts 50 cell_states rows"
        }
      },
      "schemas": {
        "database_changes": []
      },
      "files_created": [
        "app/api/sessions.py",
        "app/schemas/create_session.py",
        "app/schemas/session_snapshot.py",
        "app/services/session_create.py",
        "app/services/session_snapshot.py",
        "build-manifest.json"
      ],
      "decisions": [
        "POST /sessions accepts an optional JSON body; omitted body defaults both player names to null.",
        "Session creation is atomic in app.services.session_create.create_session using one async transaction boundary.",
        "Insufficient seeded grids is treated as service unavailability and mapped to HTTP 503 with code grids_unavailable.",
        "Snapshot serializer always nulls letter/revealed_by when revealed is false, even if inconsistent DB data exists.",
        "Canonical topics moved to SessionSnapshot.topics and each cell now serializes topics_used from cell_states.topics_used."
      ],
      "environment_variables": [],
      "enums": [
        {
          "name": "topic",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "session_status",
          "values": [
            "in_progress",
            "complete"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "revealed_by",
          "values": [
            "question",
            "guess",
            "auto"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "event_type",
          "values": [
            "question_asked",
            "question_answered",
            "letter_guessed",
            "word_guessed"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "CANONICAL_TOPICS",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "python_api"
          ]
        }
      ],
      "response_schemas": {
        "POST /sessions": {
          "201": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false,
                "exact_order": [
                  "Politics",
                  "Science",
                  "History",
                  "Art",
                  "Current Affairs"
                ]
              },
              "players": {
                "type": "array",
                "nullable": false,
                "length": 2,
                "items": {
                  "type": "object",
                  "fields": {
                    "player_number": {
                      "type": "int",
                      "nullable": false,
                      "enum": [
                        1,
                        2
                      ]
                    },
                    "name": {
                      "type": "string",
                      "nullable": true
                    },
                    "score": {
                      "type": "int",
                      "nullable": false
                    },
                    "grid_id": {
                      "type": "int",
                      "nullable": false
                    },
                    "completed": {
                      "type": "bool",
                      "nullable": false
                    },
                    "cells": {
                      "type": "array",
                      "nullable": false,
                      "items": {
                        "type": "object",
                        "fields": {
                          "index": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..24"
                          },
                          "row": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "col": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "revealed": {
                            "type": "bool",
                            "nullable": false
                          },
                          "locked": {
                            "type": "bool",
                            "nullable": false
                          },
                          "letter": {
                            "type": "string",
                            "nullable": true,
                            "constraints": "null when revealed=false; /^[A-Z]$/ when revealed=true"
                          },
                          "revealed_by": {
                            "type": "string",
                            "nullable": true,
                            "enum": [
                              "question",
                              "guess",
                              "auto"
                            ],
                            "constraints": "must be null when revealed=false"
                          },
                          "topics_used": {
                            "type": "string[]",
                            "nullable": false,
                            "enum": [
                              "Politics",
                              "Science",
                              "History",
                              "Art",
                              "Current Affairs"
                            ],
                            "max_length": 5
                          }
                        }
                      }
                    }
                  }
                }
              },
              "last_event": {
                "type": "object",
                "nullable": true,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "question_asked",
                      "question_answered",
                      "letter_guessed",
                      "word_guessed"
                    ]
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "503": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "grids_unavailable"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Not enough grids available to create a session"
                  }
                }
              }
            }
          },
          "422": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "validation_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Request validation failed"
                  },
                  "details": {
                    "type": "array | object | string",
                    "nullable": true
                  }
                }
              }
            }
          },
          "500": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "internal_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Unexpected server error"
                  }
                }
              }
            }
          }
        },
        "GET /sessions/{session_id}": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false,
                "exact_order": [
                  "Politics",
                  "Science",
                  "History",
                  "Art",
                  "Current Affairs"
                ]
              },
              "players": {
                "type": "array",
                "nullable": false,
                "length": 2,
                "items": {
                  "type": "object",
                  "fields": {
                    "player_number": {
                      "type": "int",
                      "nullable": false,
                      "enum": [
                        1,
                        2
                      ]
                    },
                    "name": {
                      "type": "string",
                      "nullable": true
                    },
                    "score": {
                      "type": "int",
                      "nullable": false
                    },
                    "grid_id": {
                      "type": "int",
                      "nullable": false
                    },
                    "completed": {
                      "type": "bool",
                      "nullable": false
                    },
                    "cells": {
                      "type": "array",
                      "nullable": false,
                      "items": {
                        "type": "object",
                        "fields": {
                          "index": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..24"
                          },
                          "row": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "col": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "revealed": {
                            "type": "bool",
                            "nullable": false
                          },
                          "locked": {
                            "type": "bool",
                            "nullable": false
                          },
                          "letter": {
                            "type": "string",
                            "nullable": true,
                            "constraints": "null when revealed=false; /^[A-Z]$/ when revealed=true"
                          },
                          "revealed_by": {
                            "type": "string",
                            "nullable": true,
                            "enum": [
                              "question",
                              "guess",
                              "auto"
                            ],
                            "constraints": "must be null when revealed=false"
                          },
                          "topics_used": {
                            "type": "string[]",
                            "nullable": false,
                            "enum": [
                              "Politics",
                              "Science",
                              "History",
                              "Art",
                              "Current Affairs"
                            ],
                            "max_length": 5
                          }
                        }
                      }
                    }
                  }
                }
              },
              "last_event": {
                "type": "object",
                "nullable": true,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "question_asked",
                      "question_answered",
                      "letter_guessed",
                      "word_guessed"
                    ]
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "session_not_found"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Session not found"
                  }
                }
              }
            }
          },
          "422": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "validation_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Request validation failed"
                  },
                  "details": {
                    "type": "array | object | string",
                    "nullable": true
                  }
                }
              }
            }
          },
          "500": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "internal_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Unexpected server error"
                  }
                }
              }
            }
          }
        }
      }
    },
    "BE-3": {
      "title": "Ask Question endpoint with deterministic stub generation and transactional event logging",
      "completed_at": "2026-02-10T19:13:53Z",
      "contracts": {
        "AskQuestionRequest": {
          "type": "object",
          "extra": "forbid",
          "required": [
            "player_number",
            "cell_index",
            "topic"
          ],
          "fields": {
            "player_number": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "cell_index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "topic": {
              "type": "Topic",
              "nullable": false,
              "enum": [
                "Politics",
                "Science",
                "History",
                "Art",
                "Current Affairs"
              ]
            }
          }
        },
        "QuestionAskedEventData": {
          "type": "object",
          "extra": "forbid",
          "required": [
            "cell_index",
            "row",
            "col",
            "topic",
            "question_text",
            "answer",
            "acceptable_variants",
            "generator"
          ],
          "fields": {
            "cell_index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "row": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "col": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "topic": {
              "type": "Topic",
              "nullable": false,
              "enum": [
                "Politics",
                "Science",
                "History",
                "Art",
                "Current Affairs"
              ]
            },
            "question_text": {
              "type": "string",
              "nullable": false,
              "max_length": 500
            },
            "answer": {
              "type": "string",
              "nullable": false,
              "min_length": 1
            },
            "acceptable_variants": {
              "type": "string[]",
              "nullable": false,
              "min_length": 1,
              "item_min_length": 1
            },
            "generator": {
              "type": "string",
              "nullable": false,
              "literal": "stub_v1"
            }
          }
        },
        "ask_question": {
          "type": "async_function",
          "signature": "ask_question(*, db: AsyncSession, session_id: uuid.UUID, player_number: int, cell_index: int, topic: Topic) -> SessionSnapshot",
          "behavior": "single transaction with row locking; validates session and turn; enforces topics_used cap; decrements score by 1; appends topic to topics_used; writes event_logs.question_asked; flushes and returns fresh SessionSnapshot"
        },
        "generate_stub_question": {
          "type": "function",
          "signature": "generate_stub_question(*, topic: Topic, required_letter: str, cell_index: int) -> StubQuestion",
          "determinism": "stable output for identical topic + required_letter + cell_index inputs"
        }
      },
      "schemas": {
        "database_changes": []
      },
      "files_created": [
        "app/core/config.py",
        "app/schemas/ask_question.py",
        "app/services/trivia_generator_stub.py",
        "app/services/session_ask.py",
        "app/api/sessions.py",
        "build-manifest.json"
      ],
      "decisions": [
        "TRIVIA_GENERATOR_MODE accepts only stub/openai and defaults to stub; Phase 3 always persists generator=stub_v1 and uses deterministic stub output even when mode=openai.",
        "Ask flow is fully transactional with FOR UPDATE locks on sessions and cell_states to serialize score/topic mutations and prevent race-condition drift.",
        "required_letter is derived from the acting player's immutable grid cells string at cell_index rather than cell_states.letter.",
        "topics_used mutations reassign a new list instead of in-place append to guarantee SQLAlchemy change tracking for ARRAY columns.",
        "Missing cell_state/grid rows are treated as unexpected integrity faults and bubble to centralized 500 internal_error handling."
      ],
      "environment_variables": [
        {
          "key": "TRIVIA_GENERATOR_MODE",
          "required": false,
          "default": "stub",
          "allowed_values": [
            "stub",
            "openai"
          ],
          "description": "Selects trivia question generator mode; Phase 3 keeps deterministic stub generation for both values."
        }
      ],
      "enums": [
        {
          "name": "topic",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "event_type",
          "values": [
            "question_asked",
            "question_answered",
            "letter_guessed",
            "word_guessed"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "session_status",
          "values": [
            "in_progress",
            "complete"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "revealed_by",
          "values": [
            "question",
            "guess",
            "auto"
          ],
          "layers": [
            "postgres",
            "python_db",
            "python_api"
          ]
        },
        {
          "name": "CANONICAL_TOPICS",
          "values": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "layers": [
            "python_api"
          ]
        },
        {
          "name": "TRIVIA_GENERATOR_MODE",
          "values": [
            "stub",
            "openai"
          ],
          "layers": [
            "python_api",
            "environment"
          ]
        }
      ],
      "response_schemas": {
        "POST /sessions/{session_id}/ask": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false,
                "exact_order": [
                  "Politics",
                  "Science",
                  "History",
                  "Art",
                  "Current Affairs"
                ]
              },
              "players": {
                "type": "array",
                "nullable": false,
                "length": 2,
                "items": {
                  "type": "object",
                  "fields": {
                    "player_number": {
                      "type": "int",
                      "nullable": false,
                      "enum": [
                        1,
                        2
                      ]
                    },
                    "name": {
                      "type": "string",
                      "nullable": true
                    },
                    "score": {
                      "type": "int",
                      "nullable": false
                    },
                    "grid_id": {
                      "type": "int",
                      "nullable": false
                    },
                    "completed": {
                      "type": "bool",
                      "nullable": false
                    },
                    "cells": {
                      "type": "array",
                      "nullable": false,
                      "items": {
                        "type": "object",
                        "fields": {
                          "index": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..24"
                          },
                          "row": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "col": {
                            "type": "int",
                            "nullable": false,
                            "range": "0..4"
                          },
                          "revealed": {
                            "type": "bool",
                            "nullable": false
                          },
                          "locked": {
                            "type": "bool",
                            "nullable": false
                          },
                          "letter": {
                            "type": "string",
                            "nullable": true,
                            "constraints": "null when revealed=false; /^[A-Z]$/ when revealed=true"
                          },
                          "revealed_by": {
                            "type": "string",
                            "nullable": true,
                            "enum": [
                              "question",
                              "guess",
                              "auto"
                            ],
                            "constraints": "must be null when revealed=false"
                          },
                          "topics_used": {
                            "type": "string[]",
                            "nullable": false,
                            "enum": [
                              "Politics",
                              "Science",
                              "History",
                              "Art",
                              "Current Affairs"
                            ],
                            "max_length": 5
                          }
                        }
                      }
                    }
                  }
                }
              },
              "last_event": {
                "type": "object",
                "nullable": true,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "question_asked",
                      "question_answered",
                      "letter_guessed",
                      "word_guessed"
                    ]
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false,
                    "fields": {
                      "cell_index": {
                        "type": "int",
                        "nullable": false
                      },
                      "row": {
                        "type": "int",
                        "nullable": false
                      },
                      "col": {
                        "type": "int",
                        "nullable": false
                      },
                      "topic": {
                        "type": "string",
                        "nullable": false
                      },
                      "question_text": {
                        "type": "string",
                        "nullable": false
                      },
                      "answer": {
                        "type": "string",
                        "nullable": false
                      },
                      "acceptable_variants": {
                        "type": "string[]",
                        "nullable": false
                      },
                      "generator": {
                        "type": "string",
                        "nullable": false,
                        "literal": "stub_v1"
                      }
                    }
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "session_not_found"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Session not found"
                  }
                }
              }
            }
          },
          "409": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "session_not_in_progress",
                      "out_of_turn",
                      "topics_exhausted"
                    ]
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "enum": [
                      "Session is not in progress",
                      "It is not this player's turn",
                      "No topics remaining for this cell"
                    ]
                  }
                }
              }
            }
          },
          "422": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "validation_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Request validation failed"
                  },
                  "details": {
                    "type": "array | object | string",
                    "nullable": true
                  }
                }
              }
            }
          },
          "500": {
            "type": "object",
            "fields": {
              "error": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "code": {
                    "type": "string",
                    "nullable": false,
                    "literal": "internal_error"
                  },
                  "message": {
                    "type": "string",
                    "nullable": false,
                    "literal": "Unexpected server error"
                  }
                }
              }
            }
          }
        }
      }
    },
    "BE-4": {
      "title": "OpenAI Responses API integration for /ask plus new /answer endpoint",
      "completed_at": "2026-02-10T20:18:39Z",
      "contracts": {
        "AnswerQuestionRequest": {
          "type": "object",
          "fields": {
            "player_number": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "answer": {
              "type": "string",
              "nullable": false,
              "constraints": "strip_whitespace=true, min_length=1, max_length=100"
            }
          },
          "additional_properties": false
        },
        "QuestionAnsweredEventData": {
          "type": "object",
          "fields": {
            "cell_index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "row": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "col": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "topic": {
              "type": "Topic",
              "nullable": false
            },
            "answer": {
              "type": "string",
              "nullable": false,
              "min_length": 1
            },
            "correct": {
              "type": "bool",
              "nullable": false
            },
            "revealed_letter": {
              "type": "string",
              "nullable": true,
              "constraints": "null when correct=false; /^[A-Z]$/ when correct=true"
            },
            "lock_cleared_cell_index": {
              "type": "int",
              "nullable": true,
              "range": "0..24 when present"
            }
          },
          "additional_properties": false
        },
        "generate_openai_question": {
          "type": "async_function",
          "signature": "generate_openai_question(session_id, player_number, cell_index, topic, required_letter, prior_questions, db) -> tuple[dict[str, Any], OpenAiResponseLog]",
          "behavior": [
            "Uses OpenAI Responses API model gpt-5-mini with strict JSON Schema response format.",
            "Creates one openai_response_logs row per attempt (attempts 1..3).",
            "Applies semantic guards and retries up to 2 times on failures.",
            "Returns parsed payload plus successful OpenAiResponseLog row."
          ]
        },
        "QuestionAskedEventData.generator": {
          "type": "literal",
          "values": [
            "stub_v1",
            "openai_responses_v1"
          ]
        }
      },
      "schemas": {
        "database_tables": {
          "openai_response_logs": {
            "ddl": "CREATE TABLE openai_response_logs (id BIGSERIAL PRIMARY KEY, session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE, player_number SMALLINT NOT NULL CHECK (player_number IN (1,2)), cell_index SMALLINT NOT NULL CHECK (cell_index BETWEEN 0 AND 24), topic topic NOT NULL, attempt SMALLINT NOT NULL, model TEXT NOT NULL, request_payload JSONB NOT NULL, response_payload JSONB NULL, parsed_payload JSONB NULL, error_message TEXT NULL, event_log_id BIGINT NULL REFERENCES event_logs(id) ON DELETE SET NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now());",
            "indexes": [
              "CREATE INDEX openai_response_logs_session_created_idx ON openai_response_logs (session_id, created_at DESC, id DESC);",
              "CREATE INDEX openai_response_logs_event_log_id_idx ON openai_response_logs (event_log_id);",
              "CREATE INDEX openai_response_logs_session_player_cell_idx ON openai_response_logs (session_id, player_number, cell_index);"
            ]
          }
        },
        "sqlalchemy_models": {
          "OpenAiResponseLog": "Table openai_response_logs with attempt-level request/response/parse/error payloads and optional link to event_logs.id."
        }
      },
      "files_created": [
        "app/db/models/openai_response_log.py",
        "alembic/versions/20260210_204500_create_openai_response_logs.py",
        "app/schemas/answer_question.py",
        "app/services/openai_client.py",
        "app/services/trivia_generator_openai.py",
        "app/services/rate_limit.py",
        "app/services/session_answer.py",
        "tests/test_answer_endpoint.py",
        "tests/test_openai_ask_integration.py",
        "tests/test_rate_limiting.py",
        "app/schemas/ask_question.py",
        "app/services/session_ask.py",
        "app/api/sessions.py",
        "app/core/config.py",
        "app/db/models/__init__.py",
        "requirements.txt",
        "build-manifest.json"
      ],
      "decisions": [
        "Used official OpenAI Python SDK (`openai`) and AsyncOpenAI client singleton via lru_cache.",
        "Implemented strict JSON Schema output on Responses API with `additionalProperties:false` and `strict:true`, then added semantic guard retries (max 3 attempts).",
        "Stored attempt logs in openai_response_logs before each API call and linked successful attempt to question_asked event_log_id.",
        "Rate limiting is in-process and keyed by (session_id, client_ip), enforced only on POST /sessions/{session_id}/ask.",
        "Pending question resolution for /answer uses most recent question_asked versus question_answered timestamps per player.",
        "Answer correctness is exact after trim+casefold against acceptable_variants; no fuzzy/semantic matching added."
      ],
      "environment_variables": [
        {
          "key": "ASK_RATE_LIMIT_REQUESTS",
          "required": false,
          "description": "Maximum number of /ask requests allowed per (session_id, client_ip) window. Default 10."
        },
        {
          "key": "ASK_RATE_LIMIT_WINDOW_SECONDS",
          "required": false,
          "description": "Sliding window size in seconds for /ask rate limiting. Default 60."
        }
      ],
      "enums": [],
      "response_schemas": {
        "POST /sessions/{session_id}/ask": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false
              },
              "players": {
                "type": "PlayerSnapshot[2]",
                "nullable": false
              },
              "last_event": {
                "type": "object",
                "nullable": true,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "literal": "question_asked"
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false,
                    "fields": {
                      "cell_index": {
                        "type": "int",
                        "nullable": false
                      },
                      "row": {
                        "type": "int",
                        "nullable": false
                      },
                      "col": {
                        "type": "int",
                        "nullable": false
                      },
                      "topic": {
                        "type": "string",
                        "nullable": false
                      },
                      "question_text": {
                        "type": "string",
                        "nullable": false
                      },
                      "answer": {
                        "type": "string",
                        "nullable": false
                      },
                      "acceptable_variants": {
                        "type": "string[]",
                        "nullable": false
                      },
                      "generator": {
                        "type": "string",
                        "nullable": false,
                        "enum": [
                          "stub_v1",
                          "openai_responses_v1"
                        ]
                      }
                    }
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_found",
              "message": "Session not found",
              "details": null
            }
          },
          "409": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_in_progress | out_of_turn | topics_exhausted",
              "message": "Session is not in progress | It is not this player's turn | No topics remaining for this cell",
              "details": null
            }
          },
          "429": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "rate_limited",
              "message": "Too many requests",
              "details": {
                "retry_after_seconds": "int"
              }
            }
          },
          "503": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "openai_unavailable",
              "message": "Trivia generation is temporarily unavailable",
              "details": null
            }
          },
          "422": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "validation_error",
              "message": "Request validation failed",
              "details": "array | object | string | null"
            }
          },
          "500": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "internal_error",
              "message": "Unexpected server error",
              "details": null
            }
          }
        },
        "POST /sessions/{session_id}/answer": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false
              },
              "players": {
                "type": "PlayerSnapshot[2]",
                "nullable": false
              },
              "last_event": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "literal": "question_answered"
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false,
                    "fields": {
                      "cell_index": {
                        "type": "int",
                        "nullable": false
                      },
                      "row": {
                        "type": "int",
                        "nullable": false
                      },
                      "col": {
                        "type": "int",
                        "nullable": false
                      },
                      "topic": {
                        "type": "string",
                        "nullable": false
                      },
                      "answer": {
                        "type": "string",
                        "nullable": false
                      },
                      "correct": {
                        "type": "bool",
                        "nullable": false
                      },
                      "revealed_letter": {
                        "type": "string",
                        "nullable": true
                      },
                      "lock_cleared_cell_index": {
                        "type": "int",
                        "nullable": true
                      }
                    }
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_found",
              "message": "Session not found",
              "details": null
            }
          },
          "409": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_in_progress | out_of_turn | no_pending_question",
              "message": "Session is not in progress | It is not this player's turn | No pending question to answer",
              "details": null
            }
          },
          "422": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "validation_error",
              "message": "Request validation failed",
              "details": "array | object | string | null"
            }
          },
          "500": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "internal_error",
              "message": "Unexpected server error",
              "details": null
            }
          }
        }
      }
    },
    "BE-5": {
      "title": "Guess letter/word endpoints with turn enforcement, scoring, locking, and word-cascade reveals",
      "completed_at": "2026-02-10T21:03:33Z",
      "contracts": {
        "GuessDirection": {
          "type": "enum",
          "values": [
            "across",
            "down"
          ],
          "layer": "python_api_only"
        },
        "GuessLetterRequest": {
          "type": "object",
          "fields": {
            "player_number": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "cell_index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "letter": {
              "type": "string",
              "nullable": false,
              "constraints": "^[A-Za-z]$"
            }
          },
          "additional_properties": false
        },
        "GuessWordRequest": {
          "type": "object",
          "fields": {
            "player_number": {
              "type": "literal 1 | 2",
              "nullable": false
            },
            "direction": {
              "type": "GuessDirection",
              "nullable": false
            },
            "index": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "word": {
              "type": "string",
              "nullable": false,
              "constraints": "^[A-Za-z]{5}$"
            }
          },
          "additional_properties": false
        },
        "LetterGuessedEventData": {
          "type": "object",
          "fields": {
            "cell_index": {
              "type": "int",
              "nullable": false,
              "range": "0..24"
            },
            "row": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "col": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "guessed_letter": {
              "type": "string",
              "nullable": false,
              "constraints": "^[A-Z]$"
            },
            "correct": {
              "type": "bool",
              "nullable": false
            },
            "revealed_letter": {
              "type": "string",
              "nullable": true,
              "constraints": "null when correct=false; /^[A-Z]$/ when present"
            },
            "score_delta": {
              "type": "int",
              "nullable": false,
              "values": [
                0,
                -5
              ]
            },
            "opponent_score_delta": {
              "type": "int",
              "nullable": false,
              "values": [
                0,
                1
              ]
            },
            "locks_enqueued": {
              "type": "int[]",
              "nullable": false,
              "constraints": "[] when correct=true; [cell_index] when correct=false"
            },
            "auto_reveals": {
              "type": "RevealedCellEvent[]",
              "nullable": false
            }
          },
          "additional_properties": false
        },
        "WordGuessedEventData": {
          "type": "object",
          "fields": {
            "direction": {
              "type": "GuessDirection",
              "nullable": false
            },
            "index": {
              "type": "int",
              "nullable": false,
              "range": "0..4"
            },
            "guessed_word": {
              "type": "string",
              "nullable": false,
              "constraints": "^[A-Z]{5}$"
            },
            "correct": {
              "type": "bool",
              "nullable": false
            },
            "revealed_cells": {
              "type": "RevealedCellEvent[]",
              "nullable": false,
              "constraints": "ascending cell_index; only cells revealed directly by guess"
            },
            "score_delta": {
              "type": "int",
              "nullable": false,
              "values": [
                0,
                -5
              ]
            },
            "opponent_score_delta": {
              "type": "int",
              "nullable": false,
              "values": [
                0,
                1
              ]
            },
            "locks_enqueued": {
              "type": "int[]",
              "nullable": false,
              "constraints": "ascending cell_index; unrevealed target cells only when incorrect"
            },
            "auto_reveals": {
              "type": "RevealedCellEvent[]",
              "nullable": false,
              "constraints": "cascade reveal sequence order"
            }
          },
          "additional_properties": false
        },
        "guess_letter": {
          "type": "async_function",
          "signature": "guess_letter(db: AsyncSession, session_id: UUID, player_number: int, cell_index: int, letter: str) -> SessionSnapshot",
          "raises": [
            "SessionNotFoundError",
            "SessionNotInProgressError",
            "OutOfTurnError",
            "CellAlreadyRevealedError",
            "CellLockedError"
          ]
        },
        "guess_word": {
          "type": "async_function",
          "signature": "guess_word(db: AsyncSession, session_id: UUID, player_number: int, direction: GuessDirection, index: int, word: str) -> SessionSnapshot",
          "raises": [
            "SessionNotFoundError",
            "SessionNotInProgressError",
            "OutOfTurnError",
            "WordAlreadyRevealedError",
            "WordLockedError"
          ]
        }
      },
      "schemas": {
        "database_tables": []
      },
      "files_created": [
        "app/api/sessions.py",
        "app/schemas/enums.py",
        "app/schemas/guess_letter.py",
        "app/schemas/guess_word.py",
        "app/services/session_guess.py",
        "tests/test_guess_schemas.py",
        "tests/test_session_guess_service.py",
        "build-manifest.json"
      ],
      "decisions": [
        "Guess mutations use a new domain-service exception layer (no HTTPException in service) and explicit API-layer exception mapping to preserve exact contract codes/messages.",
        "Both guess mutations run all writes in one transaction with SELECT ... FOR UPDATE on sessions and relevant cell_states; snapshot loading is done only after commit.",
        "Word auto-reveal cascade scans deterministically each pass in fixed order: across 0..4, then down 0..4, repeating until no new reveals.",
        "Wrong word guesses enqueue cell_locks strictly in ascending cell_index order and mirror locked state into denormalized cell_states.locked.",
        "Guess event payloads are validated through strict Pydantic models before insert to prevent missing/extra keys and to enforce score/lock invariants."
      ],
      "environment_variables": [],
      "enums": [
        {
          "name": "GuessDirection",
          "values": [
            "across",
            "down"
          ],
          "layers": [
            "python_api"
          ]
        }
      ],
      "response_schemas": {
        "POST /sessions/{session_id}/guess-letter": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false
              },
              "players": {
                "type": "PlayerSnapshot[2]",
                "nullable": false
              },
              "last_event": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "literal": "letter_guessed"
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false,
                    "fields": {
                      "cell_index": {
                        "type": "int",
                        "nullable": false
                      },
                      "row": {
                        "type": "int",
                        "nullable": false
                      },
                      "col": {
                        "type": "int",
                        "nullable": false
                      },
                      "guessed_letter": {
                        "type": "string",
                        "nullable": false
                      },
                      "correct": {
                        "type": "bool",
                        "nullable": false
                      },
                      "revealed_letter": {
                        "type": "string",
                        "nullable": true
                      },
                      "score_delta": {
                        "type": "int",
                        "nullable": false
                      },
                      "opponent_score_delta": {
                        "type": "int",
                        "nullable": false
                      },
                      "locks_enqueued": {
                        "type": "int[]",
                        "nullable": false
                      },
                      "auto_reveals": {
                        "type": "object[]",
                        "nullable": false,
                        "item_fields": {
                          "cell_index": "int",
                          "row": "int",
                          "col": "int",
                          "revealed_letter": "string"
                        }
                      }
                    }
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_found",
              "message": "Session not found",
              "details": null
            }
          },
          "409": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_in_progress | out_of_turn | cell_already_revealed | cell_locked",
              "message": "Session is not in progress | It is not this player's turn | Cell is already revealed | Cell is locked",
              "details": null
            }
          },
          "422": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "validation_error",
              "message": "Request validation failed",
              "details": "array | object | string | null"
            }
          },
          "500": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "internal_error",
              "message": "Unexpected server error",
              "details": null
            }
          }
        },
        "POST /sessions/{session_id}/guess-word": {
          "200": {
            "type": "object",
            "fields": {
              "session_id": {
                "type": "string(uuid)",
                "nullable": false
              },
              "status": {
                "type": "string",
                "nullable": false,
                "enum": [
                  "in_progress",
                  "complete"
                ]
              },
              "current_turn": {
                "type": "int",
                "nullable": false,
                "enum": [
                  1,
                  2
                ]
              },
              "topics": {
                "type": "string[]",
                "nullable": false
              },
              "players": {
                "type": "PlayerSnapshot[2]",
                "nullable": false
              },
              "last_event": {
                "type": "object",
                "nullable": false,
                "fields": {
                  "type": {
                    "type": "string",
                    "nullable": false,
                    "literal": "word_guessed"
                  },
                  "event_data": {
                    "type": "object",
                    "nullable": false,
                    "fields": {
                      "direction": {
                        "type": "string",
                        "nullable": false,
                        "enum": [
                          "across",
                          "down"
                        ]
                      },
                      "index": {
                        "type": "int",
                        "nullable": false
                      },
                      "guessed_word": {
                        "type": "string",
                        "nullable": false
                      },
                      "correct": {
                        "type": "bool",
                        "nullable": false
                      },
                      "revealed_cells": {
                        "type": "object[]",
                        "nullable": false,
                        "item_fields": {
                          "cell_index": "int",
                          "row": "int",
                          "col": "int",
                          "revealed_letter": "string"
                        }
                      },
                      "score_delta": {
                        "type": "int",
                        "nullable": false
                      },
                      "opponent_score_delta": {
                        "type": "int",
                        "nullable": false
                      },
                      "locks_enqueued": {
                        "type": "int[]",
                        "nullable": false
                      },
                      "auto_reveals": {
                        "type": "object[]",
                        "nullable": false,
                        "item_fields": {
                          "cell_index": "int",
                          "row": "int",
                          "col": "int",
                          "revealed_letter": "string"
                        }
                      }
                    }
                  },
                  "created_at": {
                    "type": "string(datetime)",
                    "nullable": false
                  }
                }
              },
              "created_at": {
                "type": "string(datetime)",
                "nullable": false
              },
              "updated_at": {
                "type": "string(datetime)",
                "nullable": false
              }
            }
          },
          "404": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_found",
              "message": "Session not found",
              "details": null
            }
          },
          "409": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "session_not_in_progress | out_of_turn | word_already_revealed | word_locked",
              "message": "Session is not in progress | It is not this player's turn | Word is already fully revealed | Word contains locked cells",
              "details": null
            }
          },
          "422": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "validation_error",
              "message": "Request validation failed",
              "details": "array | object | string | null"
            }
          },
          "500": {
            "type": "ApiErrorResponse",
            "error": {
              "code": "internal_error",
              "message": "Unexpected server error",
              "details": null
            }
          }
        }
      }
    }
  }
}
