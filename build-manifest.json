{
  "last_updated_by": null,
  "last_updated_at": null,
  "nodes": {
    "BE-1": {
      "title": "Core data model + migrations (Session, Grid, CellState, EventLog)",
      "completed_at": "2026-02-10T07:31:04Z",
      "contracts": {
        "orm_models": {
          "Session": {
            "table": "sessions",
            "primary_key": [
              "session_id"
            ],
            "relationships": [
              "player_1_grid -> grids.grid_id",
              "player_2_grid -> grids.grid_id",
              "cell_states -> cell_states.session_id",
              "event_logs -> event_logs.session_id"
            ]
          },
          "Grid": {
            "table": "grids",
            "primary_key": [
              "grid_id"
            ]
          },
          "CellState": {
            "table": "cell_states",
            "primary_key": [
              "session_id",
              "player_id",
              "cell_index"
            ],
            "relationships": [
              "session -> sessions.session_id"
            ]
          },
          "EventLog": {
            "table": "event_logs",
            "primary_key": [
              "event_id"
            ],
            "relationships": [
              "session -> sessions.session_id"
            ]
          }
        }
      },
      "schemas": {
        "enums": {
          "session_status": [
            "in_progress",
            "complete"
          ],
          "revealed_by": [
            "question",
            "guess",
            "auto"
          ],
          "event_type": [
            "question_asked",
            "question_answered",
            "letter_guessed",
            "word_guessed"
          ]
        },
        "tables": {
          "grids": {
            "columns": {
              "grid_id": "uuid pk",
              "cells": "char(1)[] not null",
              "words_across": "text[] not null",
              "words_down": "text[] not null",
              "created_at": "timestamptz not null default now()",
              "updated_at": "timestamptz not null default now()"
            },
            "checks": [
              "array_length(cells, 1) = 25",
              "array_length(words_across, 1) = 5",
              "array_length(words_down, 1) = 5"
            ]
          },
          "sessions": {
            "columns": {
              "session_id": "uuid pk",
              "player_1_id": "uuid not null",
              "player_2_id": "uuid not null",
              "player_1_name": "varchar(30) null",
              "player_2_name": "varchar(30) null",
              "player_1_grid_id": "uuid not null fk grids(grid_id) on delete restrict",
              "player_2_grid_id": "uuid not null fk grids(grid_id) on delete restrict",
              "current_turn": "smallint not null default 1",
              "player_1_score": "int not null default 100",
              "player_2_score": "int not null default 100",
              "status": "session_status not null default 'in_progress'",
              "created_at": "timestamptz not null default now()",
              "updated_at": "timestamptz not null default now()"
            },
            "checks": [
              "current_turn in (1, 2)"
            ],
            "indexes": [
              "ix_sessions_status(status)",
              "ix_sessions_updated_at(updated_at)"
            ]
          },
          "cell_states": {
            "columns": {
              "session_id": "uuid not null fk sessions(session_id) on delete cascade",
              "player_id": "smallint not null",
              "cell_index": "smallint not null",
              "revealed": "boolean not null default false",
              "locked": "boolean not null default false",
              "topics_used": "text[] not null default '{}'",
              "revealed_by": "revealed_by null",
              "created_at": "timestamptz not null default now()",
              "updated_at": "timestamptz not null default now()"
            },
            "primary_key": [
              "session_id",
              "player_id",
              "cell_index"
            ],
            "checks": [
              "player_id in (1, 2)",
              "cell_index between 0 and 24",
              "array_length(topics_used, 1) is null or array_length(topics_used, 1) <= 5"
            ],
            "indexes": [
              "cell_states_session_player_idx(session_id, player_id)",
              "cell_states_session_idx(session_id)"
            ]
          },
          "event_logs": {
            "columns": {
              "event_id": "uuid pk",
              "session_id": "uuid not null fk sessions(session_id) on delete cascade",
              "player_id": "smallint not null",
              "timestamp": "timestamptz not null default now()",
              "event_type": "event_type not null",
              "event_data": "jsonb not null default '{}'",
              "created_at": "timestamptz not null default now()",
              "updated_at": "timestamptz not null default now()"
            },
            "checks": [
              "player_id in (1, 2)"
            ],
            "indexes": [
              "event_logs_session_timestamp_idx(session_id, timestamp)",
              "event_logs_session_event_type_idx(session_id, event_type)"
            ]
          }
        }
      },
      "files_created": [
        "app/db/base.py",
        "app/db/models/__init__.py",
        "app/db/models/enums.py",
        "app/db/models/grid.py",
        "app/db/models/session.py",
        "app/db/models/cell_state.py",
        "app/db/models/event_log.py",
        "alembic/versions/20260210_be1_core_data_model.py",
        "build-manifest.json"
      ],
      "decisions": [
        "UUIDs are application-generated in ORM models (`default=uuid.uuid4`) and no DB uuid extension is required by migration DDL.",
        "Enums are explicitly created/dropped in Alembic and referenced with `create_type=False` to prevent duplicate CREATE TYPE emissions.",
        "`updated_at` uses server default `now()` and ORM-side `onupdate=sa.func.now()` on all four models for consistency.",
        "Included `cell_states_session_idx` and `event_logs_session_event_type_idx` in addition to required indexes for snapshot/caching query performance."
      ],
      "environment_variables": []
    },
    "BE-2-2": {
      "title": "Input validation schemas + mutation rule guards for session endpoints",
      "completed_at": "2026-02-10T08:46:33Z",
      "contracts": {
        "api_enums": {
          "Topic": [
            "Politics",
            "Science",
            "History",
            "Art",
            "Current Affairs"
          ],
          "Direction": [
            "across",
            "down"
          ],
          "SessionStatus": [
            "in_progress",
            "complete"
          ],
          "RevealedBy": [
            "question",
            "guess",
            "auto"
          ]
        },
        "request_models": {
          "AskRequest": {
            "player_number": "Literal[1,2]",
            "square": "SquareRef (cell_index 0..24 OR row 0..4 + col 0..4)",
            "topic": "Topic"
          },
          "AnswerRequest": {
            "player_number": "Literal[1,2]",
            "answer": "trimmed string length 1..2000"
          },
          "GuessLetterRequest": {
            "player_number": "Literal[1,2]",
            "cell_index": "int 0..24",
            "letter": "single uppercase A-Z (normalized)"
          },
          "GuessWordRequest": {
            "player_number": "Literal[1,2]",
            "direction": "Direction",
            "index": "int 0..4",
            "word": "exactly five uppercase A-Z letters (normalized)"
          },
          "SkipRequest": {
            "player_number": "Literal[1,2]"
          }
        },
        "response_models": {
          "SessionSnapshot": {
            "session_id": "uuid",
            "status": "SessionStatus",
            "current_turn": "Literal[1,2]",
            "players": "list[PlayerSnapshot] length 2",
            "last_event": "LastEventSnapshot | null"
          },
          "PlayerSnapshot": {
            "player_number": "Literal[1,2]",
            "name": "string | null",
            "score": "int",
            "grid_id": "uuid",
            "cells": "list[CellSnapshot] length 25",
            "completed": "bool"
          },
          "CellSnapshot": {
            "index": "int 0..24",
            "row": "int 0..4",
            "col": "int 0..4",
            "revealed": "bool",
            "letter": "single uppercase A-Z | null",
            "locked": "bool",
            "topics_used": "list[str] subset of Topic values",
            "revealed_by": "RevealedBy | null"
          },
          "LastEventSnapshot": {
            "type": "string",
            "result": "ok | error | null",
            "message_to_speak": "string | null"
          }
        },
        "mutation_endpoints": {
          "POST /sessions": "501 placeholder (session creation owned by BE-2)",
          "GET /sessions/{session_id}": "SessionSnapshot",
          "POST /sessions/{session_id}/ask": "AskRequest -> SessionSnapshot",
          "POST /sessions/{session_id}/answer": "AnswerRequest -> SessionSnapshot",
          "POST /sessions/{session_id}/guess-letter": "GuessLetterRequest -> SessionSnapshot",
          "POST /sessions/{session_id}/guess-word": "GuessWordRequest -> SessionSnapshot",
          "POST /sessions/{session_id}/skip": "SkipRequest -> SessionSnapshot"
        },
        "error_contract": {
          "ApiError": {
            "error": {
              "code": "string",
              "message": "string",
              "details": "any | null"
            }
          },
          "status_mapping": {
            "404": "SESSION_NOT_FOUND",
            "409": "rule violations (OUT_OF_TURN, CELL_LOCKED, CELL_ALREADY_REVEALED, TOPIC_ALREADY_USED, SESSION_NOT_IN_PROGRESS, STATE_CORRUPT)",
            "422": "request validation errors"
          }
        },
        "guard_functions": [
          "load_session_or_404",
          "ensure_in_progress",
          "ensure_turn_owner",
          "load_cell_state",
          "ensure_cell_not_revealed",
          "ensure_cell_not_locked_for_guess",
          "ensure_topic_allowed_and_unused",
          "ensure_guess_word_cells_unlocked",
          "ensure_session_ready_for_mutation",
          "ensure_pending_question_exists (BE-3/BE-4 hook)"
        ]
      },
      "schemas": {
        "database": "No database schema changes in BE-2-2.",
        "pydantic_modules": [
          "app/api/schemas/enums.py",
          "app/api/schemas/common.py",
          "app/api/schemas/requests.py",
          "app/api/schemas/snapshots.py"
        ]
      },
      "files_created": [
        "app/api/errors.py",
        "app/api/guards.py",
        "app/api/routes/sessions.py",
        "app/api/schemas/__init__.py",
        "app/api/schemas/common.py",
        "app/api/schemas/enums.py",
        "app/api/schemas/requests.py",
        "app/api/schemas/snapshots.py",
        "app/api/utils/__init__.py",
        "app/api/utils/grid.py",
        "tests/test_be_2_2_validation_and_guards.py",
        "app/api/router.py",
        "app/main.py",
        "build-manifest.json"
      ],
      "decisions": [
        "All mutating session endpoints are exposed now as contract-stable placeholders that execute validation and guard checks, then return the canonical snapshot until BE-3/BE-4 persistence logic lands.",
        "Square references are normalized via a dedicated `SquareRef` model to enforce exactly one addressing mode: `cell_index` or `row/col`.",
        "Guard failures are raised as structured API exceptions (`NotFoundError`, `RuleViolationError`) and mapped to consistent error payloads centrally in `app/main.py`.",
        "Session snapshot construction reads authoritative DB state (Session + CellState + latest EventLog) and validates strict player/cell cardinality to detect corrupt state early."
      ],
      "environment_variables": []
    },
    "BE-0": {
      "title": "Backend Scaffold (FastAPI + Async SQLAlchemy)",
      "completed_at": "2026-02-10T06:31:55.851340+00:00",
      "contracts": "`GET /health`\n- Query: `db` (bool-like via FastAPI boolean parsing; supports `1,true,yes` and `0,false,no`)\n- `200` (default, or `db=1` and DB reachable):\n  - `{ \"status\": \"ok\", \"service\": string, \"env\": string, \"version\": \"0.1.0\", \"uptime_s\": number, \"db\": { \"checked\": boolean, \"ok\": boolean|null } }`\n- `503` (only when `db=1` and DB check fails):\n  - `{ \"status\": \"degraded\", \"service\": string, \"env\": string, \"version\": \"0.1.0\", \"uptime_s\": number, \"db\": { \"checked\": true, \"ok\": false, \"error\": \"database_unreachable\"|\"database_timeout\"|\"database_error\" } }`\n\nGlobal error handlers in `app/main.py`:\n- `422` validation: `{ \"error\": { \"code\": \"validation_error\", \"message\": \"Invalid request\", \"details\": [...] }, \"request_id\": \"...\" }`\n- `500` unhandled: `{ \"error\": { \"code\": \"internal_error\", \"message\": \"Internal server error\", \"details\": [] }, \"request_id\": \"...\" }`\n- Adds `X-Request-ID` header.",
      "schemas": "No domain tables/models added in this node. Alembic is wired to `app.db.base.Base.metadata` for future BE-1 models.",
      "files_created": [
        "requirements.txt",
        "requirements-dev.txt",
        ".env.example",
        "alembic.ini",
        "alembic/env.py",
        "alembic/script.py.mako",
        "alembic/versions/.gitkeep",
        "app/__init__.py",
        "app/main.py",
        "app/api/__init__.py",
        "app/api/router.py",
        "app/api/routes/__init__.py",
        "app/api/routes/health.py",
        "app/core/__init__.py",
        "app/core/config.py",
        "app/core/logging.py",
        "app/core/middleware.py",
        "app/db/__init__.py",
        "app/db/base.py",
        "app/db/session.py",
        "tests/__init__.py",
        "tests/test_health.py",
        "pytest.ini"
      ],
      "decisions": "1) Settings: Pydantic Settings v2 with `.env` support for local dev (`app/core/config.py:10`).\n2) DB URL normalization: accept `postgres://` and normalize to:\n- runtime async `postgresql+asyncpg://` (`app/db/session.py:12`)\n- alembic sync `postgresql+psycopg://` (`app/db/session.py:34`)\n3) Migrations driver: Alembic intentionally uses sync psycopg (`alembic/env.py:18`).",
      "environment_variables": [
        {
          "key": "DATABASE_URL",
          "description": "Required. Accepts Render-style `postgres://...`; normalized for runtime and Alembic."
        },
        {
          "key": "OPENAI_API_KEY",
          "description": "Optional placeholder for later nodes."
        },
        {
          "key": "CORS_ALLOW_ORIGINS",
          "description": "Optional comma-separated origins. Default `http://localhost:5173`."
        },
        {
          "key": "LOG_LEVEL",
          "description": "Optional. Default `INFO`."
        },
        {
          "key": "ENV",
          "description": "Optional. `local|staging|production`, default `local`."
        },
        {
          "key": "SERVICE_NAME",
          "description": "Optional. Default `five-by-backend`."
        }
      ]
    },
    "BE-1-2": {
      "title": "Grid Preload + Seed Command",
      "completed_at": "2026-02-10T07:41:36.948961+00:00",
      "contracts": "Seed CLI contract implemented in `app/cli/seed_grids.py`:\n- `python -m app.cli.seed_grids --data app/data/grids.json`\n- Options: `--data`, `--limit`, `--dry-run`, `--continue-on-error`, `--log-level {DEBUG,INFO,WARNING,ERROR}`\n- Behavior: strict validation first, deterministic UUIDv5 derivation, async DB inserts with `ON CONFLICT (grid_id) DO NOTHING`, summary logging (`total_records`, `valid_count`, `invalid_count`, `inserted_count`, `skipped_count`, `dry_run`, `limit`), non-zero exit when invalid rows exist.\n\nValidation contract in `app/core/grid_validation.py`:\n- Normalizes `strip().upper()`.\n- Enforces exact keys (`cells`, `words_across`, `words_down`), shape/type rules, regex checks (`cells`=`^[A-Z]{25}$`, words=`^[A-Z]{5}$`), across/down cross-consistency, and in-file uniqueness for both `cells` and derived `grid_id`.\n- Emits row-scoped issues with `row_index`, `reason`, optional `value`.\n\nDeterministic ID contract in `app/core/grid_id.py`:\n- `derive_grid_id(cells, words_across, words_down) -> UUID` using UUIDv5 with a fixed namespace and stable payload string.",
      "schemas": "`Grid` ORM updated in `app/db/models/grid.py`:\n- `grid_id UUID PK`\n- `cells VARCHAR(25) NOT NULL`\n- `words_across TEXT[] NOT NULL`\n- `words_down TEXT[] NOT NULL`\n- Constraints: `UNIQUE(cells)`, `CHECK(length(cells)=25)`, `CHECK(cells ~ '^[A-Z]{25}$')`, array length checks for across/down = 5.\n\nAlembic revision `20260210_be1_2` in `alembic/versions/20260210_be1_2_grid_constraints_and_uniqueness.py`:\n- Creates `grids` if missing (canonical shape + constraints).\n- For existing `grids`, converts `cells` from array form to `VARCHAR(25)` (using `array_to_string(cells, '')`), ensures constraints and uniqueness on `cells`.\n- Downgrade restores array-backed `cells` and prior length check semantics.",
      "files_created": [
        "app/core/grid_id.py",
        "app/core/grid_validation.py",
        "app/cli/__init__.py",
        "app/cli/__main__.py",
        "app/cli/seed_grids.py",
        "app/data/grids.json",
        "alembic/versions/20260210_be1_2_grid_constraints_and_uniqueness.py"
      ],
      "decisions": "- Kept the repository\u2019s existing model layout (`app/db/models`) instead of introducing a parallel `app/models` tree.\n- Treated grids as immutable by convention via model docstring and by only adding offline CLI seeding paths (no HTTP endpoints, no update workflows).\n- Implemented strict key validation (extra/missing keys are invalid).\n- `invalid_count` reports invalid row count (not raw issue count) for clearer CLI summaries.\n- Enforced idempotency with deterministic UUIDv5 + `ON CONFLICT (grid_id) DO NOTHING`, while DB-level `UNIQUE(cells)` catches payload/ID divergence.",
      "environment_variables": []
    },
    "BE-2": {
      "title": "Session Lifecycle APIs + Snapshot Serializer",
      "completed_at": "2026-02-10T08:48:50.927934",
      "contracts": "Implemented `POST /sessions` and `GET /sessions/{session_id}` returning canonical `SessionSnapshot`.\n- `POST /sessions`: trims optional names, selects two random distinct grids, creates session + 50 cell states in one transaction, returns snapshot with synthetic `last_event={type:\"session_created\",result:\"ok\"}` when no log exists.\n- `GET /sessions/{session_id}`: loads session/cells/grids/latest event and returns deterministic snapshot; 404 when missing.\n- Determinism enforced: players `[1,2]`, cells ordered `0..24`, `row=index//5`, `col=index%5`, unrevealed `letter` omitted.",
      "schemas": "No DB schema changes.",
      "files_created": [
        "app/api/routes/sessions.py",
        "app/schemas/sessions.py",
        "app/schemas/snapshot.py",
        "app/schemas/__init__.py",
        "app/services/snapshot_serializer.py",
        "app/services/__init__.py",
        "tests/test_sessions_lifecycle.py"
      ],
      "decisions": "- `last_event` is always an object; GET fallback is `{type:\"none\"}`, POST fallback is `{type:\"session_created\",result:\"ok\"}` when no `event_logs` row exists.\n- Grid assignment uses `ORDER BY random() LIMIT 2`; creation returns 503 with clear message if fewer than 2 grids.\n- Snapshot serialization is centralized in `serialize_session_snapshot(...)` and always built from fresh post-write reads.",
      "environment_variables": []
    }
  }
}
